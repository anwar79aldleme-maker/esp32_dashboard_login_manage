<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Patients | ESP32 Dashboard</title>
<style>
body { font-family:Segoe UI; background:#0a0f1a; color:#fff; margin:0; padding:0;}
.container { width:95%; margin:20px auto; }
h2 { text-align:center; color:#00ffff; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #00ffff; padding:10px; text-align:center; }
th { background:#004d40; }
input, button { padding:8px; margin:5px; border-radius:6px; border:none; }
button { background:#00ffff; color:#000; cursor:pointer; font-weight:bold; }
button:hover { background:#00bcd4; color:#fff; }
input[type="text"], input[type="number"] { width:100%; }
.actions { display:flex; gap:5px; justify-content:center; }
.search-box { margin-top:15px; text-align:right; }
.search-box input { width:200px; }
</style>
</head>
<body>
<div class="container">
  <h2>Manage Patients</h2>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search by device or name" oninput="renderTable()">
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Device ID</th>
        <th>Name</th>
        <th>Mobile</th>
        <th>SpO₂</th>
        <th>Heart Rate</th>
        <th>Time</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <h3>Add / Edit Patient</h3>
  <div>
    <input type="text" id="device_id" placeholder="Device ID">
    <input type="text" id="Pname" placeholder="Patient Name">
    <input type="text" id="Pmobile" placeholder="Mobile">
    <input type="number" id="spo2" placeholder="SpO₂">
    <input type="number" id="heartrate" placeholder="Heart Rate">
    <button onclick="savePatient()">Save</button>
    <button onclick="clearForm()">Clear</button>
  </div>
</div>

<script>
let patients = [];
let editDeviceId = null;

// Fetch data from API
async function fetchPatients() {
  try {
    const res = await fetch('/api/patients'); // GET all patients
    const data = await res.json();
    patients = data;
    renderTable();
  } catch(err) {
    console.error('Fetch patients error:', err);
  }
}

// Render table
function renderTable() {
  const tbody = document.getElementById('tableBody');
  const search = document.getElementById('searchInput').value.toLowerCase();
  tbody.innerHTML = '';

  patients.filter(p => 
    p.device_id.toLowerCase().includes(search) || 
    p.Pname.toLowerCase().includes(search)
  ).forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.device_id}</td>
      <td>${p.Pname}</td>
      <td>${p.Pmobile}</td>
      <td>${p.spo2}</td>
      <td>${p.heartrate}</td>
      <td>${new Date(p.time).toLocaleString()}</td>
      <td class="actions">
        <button onclick="editPatient('${p.device_id}')">Edit</button>
        <button onclick="deletePatient('${p.device_id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Clear form
function clearForm() {
  editDeviceId = null;
  document.getElementById('device_id').value = '';
  document.getElementById('Pname').value = '';
  document.getElementById('Pmobile').value = '';
  document.getElementById('spo2').value = '';
  document.getElementById('heartrate').value = '';
}

// Edit patient
function editPatient(device_id) {
  const p = patients.find(p => p.device_id === device_id);
  if (!p) return;
  editDeviceId = device_id;
  document.getElementById('device_id').value = p.device_id;
  document.getElementById('Pname').value = p.Pname;
  document.getElementById('Pmobile').value = p.Pmobile;
  document.getElementById('spo2').value = p.spo2;
  document.getElementById('heartrate').value = p.heartrate;
}

// Save patient (Add or Update)
async function savePatient() {
  const device_id = document.getElementById('device_id').value;
  const Pname = document.getElementById('Pname').value;
  const Pmobile = document.getElementById('Pmobile').value;
  const spo2 = Number(document.getElementById('spo2').value);
  const heartrate = Number(document.getElementById('heartrate').value);

  if(!device_id || !Pname) return alert('Device ID and Name required');

  try {
    const method = editDeviceId ? 'PUT' : 'POST';
    const url = '/api/patients';
    const body = JSON.stringify({ device_id, Pname, Pmobile, spo2, heartrate });

    const res = await fetch(url, { method, headers: { 'Content-Type':'application/json' }, body });
    if(!res.ok) throw new Error('Request failed');

    editDeviceId = null;
    clearForm();
    fetchPatients();
  } catch(err) {
    console.error('Save patient error:', err);
  }
}

// Delete patient
async function deletePatient(device_id) {
  if(!confirm('Delete this patient?')) return;
  try {
    const res = await fetch('/api/patients', {
      method:'DELETE',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ device_id })
    });
    if(!res.ok) throw new Error('Delete failed');
    fetchPatients();
  } catch(err) {
    console.error('Delete patient error:', err);
  }
}

// Initial fetch
fetchPatients();
</script>
</body>
</html>
